import streamlit as st
import pandas as pd
import joblib
import numpy as np

# 1. Load the model and the training column names
# (Make sure you save your columns during training - see below)
@st.cache_resource
def load_model_data():
    model = joblib.load('model.pkl')
    # We need the exact column list from training to prevent the ValueError
    model_columns = joblib.load('model_columns.pkl')
    return model, model_columns

model, model_columns = load_model_data()

st.title("üìä Customer Satisfaction Predictor")

# 2. User Inputs (Matching your categorical_cols)
st.subheader("Ticket Information")

age = st.slider("Customer Age", 18, 100, 30)
duration = st.number_input("Resolution Duration (Hours)", 0.0, 500.0, 24.0)
gender = st.selectbox("Gender", ['Male', 'Female', 'Other'])
product = st.selectbox("Product Purchased", ['GoPro Hero 11', 'LG Smart TV', 'Dell XPS 13', 'iPhone 14', 'Nintendo Switch'])
t_type = st.selectbox("Ticket Type", ['Technical issue', 'Billing inquiry', 'Product inquiry', 'Cancellation request'])
priority = st.selectbox("Ticket Priority", ['Low', 'Medium', 'High', 'Critical'])
channel = st.selectbox("Ticket Channel", ['Email', 'Phone', 'Chat', 'Social media'])

if st.button("Predict"):
    # 1. Create the DataFrame using the EXACT names used in your training X
    input_df = pd.DataFrame([{
        'Customer Age': age,
        'Resolution_Duration_Hrs': duration, # Use the slider/input value here
        'Customer Gender': gender,
        'Product Purchased': product,
        'Ticket Type': t_type,
        'Ticket Priority': priority,
        'Ticket Channel': channel
    }])

    # 2. Apply One-Hot Encoding
    input_encoded = pd.get_dummies(input_df)

    # 3. Align with the model's expected columns
    # model_columns is the list you saved from X_train.columns
    final_input = input_encoded.reindex(columns=model_columns, fill_value=0)

    #st.write("Columns expected by model:", list(model_columns))
    #st.write("Columns generated by app:", list(final_input.columns))
    
    # 4. Predict
    prediction = model.predict(final_input)
    
    st.success(f"Predicted Satisfaction Rating: {prediction[0]}")
    rating = int(prediction[0])

    st.markdown("---")
    st.header(f"Predicted Rating: {rating} / 5")
    st.write("‚≠ê" * rating)